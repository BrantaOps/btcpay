@using BTCPayServer.Abstractions.Extensions
@using BTCPayServer.Plugins.Branta.Classes
@using BTCPayServer.Plugins.Branta.Enums
@using BTCPayServer.Plugins.Branta.Models
@using BTCPayServer.Plugins.Branta.Views

@model BTCPayServer.Plugins.Branta.Models.BrantaSettingsViewModel

@{
    Layout = "~/Views/Shared/_SettingsLayout.cshtml";
    ViewData["BrantaSettingsActiveTab"] = "EditBranta";
    ViewData.SetActivePage(BrantaNavPages.Index, "Branta - Settings");
}

@section PageHeadContent {
    <style>
        .input-container {
            position: relative;
        }

        .toggle-show-secret {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
        }

        .icon-actions-show,
        .icon-actions-hide {
            height: 24px;
            width: 24px;
        }

        .advanced-settings {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
        }

        .advanced-settings-details {
            padding: 1.5rem 1rem 0 2.65rem;
            background: var(--btcpay-bg-tile);
            padding: 20px;
        }

        .info > .icon-info {
            margin-left: 5px;
        }

        .info > .icon-info:hover {
            color: var(--btcpay-neutral-500) !important;
        }

        .hide-text {
            -webkit-text-security: disc;
            -moz-text-security: disc;
            text-security: disc;
            font-size: 1.2rem;
        }
    </style>
}

@section PageFootContent {
    <script>
        $(document).on('click', '.toggle-show-secret', function (e) {
            e.preventDefault();
            var targetId = $(this).data('target');
            var targetInput = $(targetId);
            var show = targetInput.hasClass('hide-text');
            targetInput.toggleClass('hide-text', !show);

            $(targetId + 'IconShow').css('display', show ? 'none' : 'block');
            $(targetId + 'IconHide').css('display', show ? 'block' : 'none');
        });
    </script>
}

<partial name="_StatusMessage" />

@if (string.IsNullOrEmpty(Model.Settings.StagingEnabled ? Model.Settings.StagingApiKey : Model.Settings.ProductionApiKey))
{
    <div class="alert alert-warning mb-4" role="alert">
        <span>
            <strong>Missing API Key.</strong>
            <span>Valid @(Model.Settings.StagingEnabled ? "Staging" : "Production") API Key is required for Branta to work.</span>
        </span>
    </div>
}

@if (Model.Settings.StagingEnabled)
{
    <div class="alert alert-warning mb-4" role="alert">
        <span><strong>Heads Up</strong> - Branta is running in Staging Mode. Toggle in Advanced settings below.</span>
    </div>
}

<div style="max-width: 800px;">

    <form method="post" id="brantaForm">
        <div class="form-group">
            <label asp-for="Settings.BrantaEnabled" class="form-label" style="padding-right: 10px;"></label>
            <input asp-for="Settings.BrantaEnabled" type="checkbox" class="btcpay-toggle" />
            @if (!Model.Settings.BrantaEnabled)
            {
                <span class="text-warning">
                    <vc:icon symbol="warning" />
                    <span>Branta must be enabled to verify payments.</span>
                </span>
            }
            <p class="text-secondary mt-2">By using Branta, you agree to our <a href="https://branta.pro/business_terms" target="_blank">Terms</a></p>
        </div>

        <div class="form-group">
            <label asp-for="Settings.ProductionApiKey" class="form-label"></label>
            <div class="input-container">
                <input id="ProductionApiKey" type="text" asp-for="Settings.ProductionApiKey" value="@Model.Settings.ProductionApiKey" class="form-control hide-text" />
                <div class="toggle-show-secret" data-target="#ProductionApiKey">
                    <span id="ProductionApiKeyIconShow"><vc:icon symbol="actions-show" /></span>
                    <span id="ProductionApiKeyIconHide" style="display: none"><vc:icon symbol="actions-hide" /></span>
                </div>
            </div>
            <span asp-validation-for="Settings.ProductionApiKey" class="text-danger"></span>
            <p class="text-secondary mt-2">Visit your Branta <a href="@BrantaSettings.GetBrantaServerUrl(ServerEnvironment.Production)/session/new" target="_blank">Dashboard</a> to create an API Key.</p>
        </div>

        <button class="accordion-button collapsed only-for-js ms-0 d-inline-block" type="button" data-bs-toggle="collapse" data-bs-target="#advanced-settings" aria-expanded="false" aria-controls="advanced-settings">
            <div class="advanced-settings">
                <div>Advanced Settings</div>
                <vc:icon symbol="caret-down" />
            </div>
        </button>

        <div id="advanced-settings" class="advanced-settings-details collapse">
            <div class="form-group">
                <label asp-for="Settings.EnableZeroKnowledge" class="form-label" style="padding-right: 10px;"></label>
                <input asp-for="Settings.EnableZeroKnowledge" type="checkbox" class="btcpay-toggle" />
                <span class="info" title="Encrypt on-chain addresses before sending to Branta.">
                    <vc:icon symbol="info" />
                </span>
            </div>

            <div class="form-group">
                <label asp-for="Settings.PostDescriptionEnabled" class="form-label" style="padding-right: 10px;"></label>
                <input asp-for="Settings.PostDescriptionEnabled" type="checkbox" class="btcpay-toggle" />
                <span class="info" title="This will show Order ID and Description to users verifying their payment. (Example: Order ID 123456 - foo bar)">
                    <vc:icon symbol="info" />
                </span>
            </div>

            <div class="form-group">
                <label asp-for="Settings.TTL" class="form-label"></label>
                <span class="info" title="Represents how long after BTCPay Server Invoice expiration should the payment be deleted from Branta.">
                    <vc:icon symbol="info" />
                </span>
                <div class="input-group">
                    <select asp-for="Settings.TTL" asp-items="Html.GetEnumSelectList<TTLOptions>()" class="form-select"></select>
                </div>
            </div>

            <div class="form-group">
                <div class="mb-2">
                    <label asp-for="Settings.StagingEnabled" class="form-label" style="padding-right: 10px;"></label>
                    <input asp-for="Settings.StagingEnabled" type="checkbox" class="btcpay-toggle" />
                    <span class="info" title="Request will be made to Staging environment instead of Production.">
                        <vc:icon symbol="info" />
                    </span>
                </div>
                <div>
                    <label asp-for="Settings.StagingApiKey" class="form-label"></label>
                    <div class="input-container">
                        <input id="StagingApiKey" type="text" asp-for="Settings.StagingApiKey" value="@Model.Settings.StagingApiKey" class="form-control hide-text" />
                        <div class="toggle-show-secret" data-target="#StagingApiKey">
                            <span id="StagingApiKeyIconShow"><vc:icon symbol="actions-show" /></span>
                            <span id="StagingApiKeyIconHide" style="display: none"><vc:icon symbol="actions-hide" /></span>
                        </div>
                    </div>
                    <span asp-validation-for="Settings.StagingApiKey" class="text-danger"></span>
                    <p class="text-secondary mt-2">Visit your Branta <a href="@BrantaSettings.GetBrantaServerUrl(ServerEnvironment.Staging)/session/new" target="_blank">Staging Dashboard</a> to create an API Key.</p>
                </div>
            </div>

            <div class="form-group">
                <label asp-for="Settings.ShowVerifyLink" class="form-label" style="padding-right: 10px;"></label>
                <input asp-for="Settings.ShowVerifyLink" type="checkbox" class="btcpay-toggle" />
            </div>
        </div>

        <button name="command" type="submit" class="btn btn-primary mt-3" value="BrantaSaveSettings">
            Save
        </button>
    </form>
</div>
